<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e293b;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        .stream-container {
            max-width: 800px;
            width: 100%;
        }

        h2 {
            color: #f1f5f9;
            margin-bottom: 16px;
            font-size: 24px;
        }

        .stream-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #334155;
            border-radius: 8px;
        }

        #stop-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            border: 2px solid #b91c1c;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #stop-button:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);
        }

        #stop-button:active {
            transform: translateY(0);
        }

        #countdown {
            font-size: 20px;
            font-weight: 700;
            color: #a855f7;
            min-width: 60px;
            text-align: right;
        }

        #video-player {
            width: 100%;
            max-height: 600px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        #status-message {
            text-align: center;
            padding: 16px;
            background: #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 14px;
        }

        .error-message {
            color: #fca5a5;
            background: #450a0a;
            border: 1px solid #7f1d1d;
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="stream-container">
        <h2 id="camera-name">Camera Stream</h2>
        <div class="stream-controls">
            <button id="stop-button">Stop Stream</button>
            <span id="countdown">60s</span>
        </div>
        <video id="video-player" controls autoplay></video>
        <div id="status-message" class="loading">Initializing stream...</div>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const serial = urlParams.get('serial');
        const cameraName = urlParams.get('name') || 'Camera';

        // Set camera name
        document.getElementById('camera-name').textContent = `${cameraName} - Live Stream`;

        // Global state
        let hls = null;
        let countdownTimer = null;
        let secondsRemaining = 60;

        // Status message element
        const statusMessage = document.getElementById('status-message');
        const videoPlayer = document.getElementById('video-player');
        const countdownElement = document.getElementById('countdown');
        const stopButton = document.getElementById('stop-button');

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            if (isError) {
                statusMessage.classList.add('error-message');
                statusMessage.classList.remove('loading');
            } else {
                statusMessage.classList.remove('error-message');
            }
        }

        function startCountdown() {
            countdownElement.textContent = `${secondsRemaining}s`;

            countdownTimer = setInterval(() => {
                secondsRemaining--;
                countdownElement.textContent = `${secondsRemaining}s`;

                if (secondsRemaining <= 0) {
                    stopStream(true); // Auto-stop
                }
            }, 1000);
        }

        function stopCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }

        async function stopStream(autoClose = false) {
            try {
                stopCountdown();

                // Stop HLS player
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                // Call stop API
                const response = await fetch(`/api/camera/${serial}/stream/stop`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to stop stream');
                }

                showStatus('Stream stopped');

                // Close window after brief delay
                if (autoClose) {
                    setTimeout(() => window.close(), 1000);
                } else {
                    setTimeout(() => window.close(), 500);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                showStatus('Error stopping stream', true);
            }
        }

        function setupHLS(streamUrl) {
            const fullStreamUrl = `/api/stream/${serial}/stream.m3u8`;

            if (Hls.isSupported()) {
                // Use HLS.js for browsers that don't natively support HLS
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });

                hls.loadSource(fullStreamUrl);
                hls.attachMedia(videoPlayer);

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('HLS manifest parsed, starting playback');
                    videoPlayer.play();
                    showStatus('Stream active');
                    startCountdown();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                if (streamRetryCount < MAX_RETRIES) {
                                    streamRetryCount++;
                                    showStatus('Network error - restarting stream...', true);
                                    hls.destroy();
                                    hls = null;
                                    // Stop and restart the whole stream
                                    fetch(`/api/camera/${serial}/stream/stop`, { method: 'POST' })
                                        .finally(() => {
                                            setTimeout(() => initStream(), 1000);
                                        });
                                } else {
                                    showStatus('Network error - stream failed', true);
                                }
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showStatus('Media error - recovering...', true);
                                hls.recoverMediaError();
                                break;
                            default:
                                showStatus('Fatal streaming error', true);
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                videoPlayer.src = fullStreamUrl;
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoPlayer.play();
                    showStatus('Stream active');
                    startCountdown();
                });
                videoPlayer.addEventListener('error', () => {
                    showStatus('Error playing stream', true);
                });
            } else {
                showStatus('HLS not supported in this browser', true);
            }
        }

        let streamRetryCount = 0;
        const MAX_RETRIES = 1;

        async function initStream() {
            try {
                showStatus(streamRetryCount > 0 ? 'Retrying...' : 'Waking camera...');

                // Call start API
                const response = await fetch(`/api/camera/${serial}/stream/start`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start stream');
                }

                const data = await response.json();

                if (!data.result) {
                    throw new Error(data.error || 'Stream initialization failed');
                }

                showStatus('Connecting to stream...');

                // Wait for GStreamer to start generating segments
                setTimeout(() => {
                    setupHLS(data.stream_url);
                }, 4000);

            } catch (error) {
                console.error('Error initializing stream:', error);
                showStatus(`Error: ${error.message}`, true);
            }
        }

        // Stop button handler
        stopButton.addEventListener('click', () => {
            stopStream(false);
        });

        // Handle window close - use sendBeacon for reliable cleanup
        window.addEventListener('beforeunload', (e) => {
            // Use sendBeacon for reliable delivery even as page unloads
            navigator.sendBeacon(`/api/camera/${serial}/stream/stop`, '');
        });

        // Initialize stream on page load
        if (!serial) {
            showStatus('Error: No camera serial provided', true);
        } else {
            initStream();
        }
    </script>
</body>
</html>
